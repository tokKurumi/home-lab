# Инструкции для Copilot: Написание документации курсовой работы

## Проект

**Название**: Проектирование и развертывание персональной серверной инфраструктуры на базе Linux и Docker-контейнеров

**Цель документации**: Создать подробный отчёт о проектировании, реализации и развертывании домашней лаборатории с использованием Docker, охватывающий архитектуру, практическую реализацию, выбор оборудования, вопросы безопасности и развертывание с удалённым доступом.

---

## Требования к документированию

### Язык и формат

- **Язык**: Русский язык (все содержание, комментарии, описания)
- **Разметка**: Typst с шаблоном ГОСТа (используется пакет `https://typst-gost.ru/`)
- **Расширение файлов**: `.typ`
- **Директория для документации**: `/doc/`
- **Директория для изображений**: `/doc/images/`

### Ссылки на исходный код

При необходимости включить ссылки на исходный код:

1. **Предпочитается**: Ссылка на файл с указанием строк кода
   - Формат: `[src/service-name/docker-compose.yml](../src/service-name/docker-compose.yml)`
   - Используйте относительные пути от `/doc/` с точками `../`

2. **Допустимо вставлять код, если**:
   - Блок кода небольшой (< 30 строк)
   - Код иллюстрирует важную концепцию архитектуры
   - Есть подробное объяснение того, что показывает код

3. **Не вставляйте полностью**:
   - Большие конфигурационные файлы (> 100 строк)
   - Повторяющийся код
   - Файлы с большим количеством служебной информации

### Примеры правильного форматирования

**Корректная ссылка**:
```typst
Конфигурация сетевых настроек находится в файле #link("../src/media/docker-compose.yml")[docker-compose.yml].
```

**Вставка небольшого кода**:
```typst
Определение сервиса WireGuard показывает использование переменных окружения:

#raw(block: true, lang: "yaml", read("../src/media/docker-compose.yml").split("\n").slice(0, 25).join("\n"))
```

---

## Основные разделы документации

Это не полная структура курсовой работы, а темы для освещения в инструкциях. Итоговая структура отчёта определяется ГОСТом и требованиями вуза.

### 0. Введение и целевая аудитория

**Что включить в инструкцию**:
- Определение целевой аудитории проекта (студенты, энтузиасты, системные администраторы)
- Уровни сложности реализации (базовая настройка vs. расширенная конфигурация)
- Основные возможности домашней лаборатории:
  - Развертывание мультиконтейнерной инфраструктуры
  - Управление медиа-содержимым (фильмы, сериалы, музыка)
  - Торрент-скачивание с VPN-защитой
  - Мониторинг и визуализация метрик
  - Безопасный удалённый доступ

### 1. Архитектура и содержание инфраструктуры

**Что включить в инструкцию**:
- Диаграмма сетевой архитектуры:
  - Виртуальные сети Docker (создаются автоматически)
  - Изоляция сервисов по назначению
  - Взаимодействие между контейнерами
  
- Диаграмма компонентов инфраструктуры:
  - Категория каждого сервиса (VPN, прокси, хранение, мониторинг, прикладные сервисы)
  - Зависимости между сервисами
  - Направление потоков данных

- Перечень основных сервисов и их назначение:
  - **Прокси/Маршрутизация**: Nginx Proxy Manager, WireGuard
  - **Управление медиа**: Prowlarr, Sonarr, Radarr, Lidarr, qBittorrent, Jellyseerr
  - **Потоковая передача**: Jellyfin, Discord Music Bot
  - **Обработка данных**: FileFlows
  - **Мониторинг**: Prometheus, Grafana, Node Exporter, cAdvisor
  - **Другие сервисы**: Dashboard (Homarr), Password Store, Auto-update

**Рекомендация для диаграмм**: Используйте Typst для встроенных диаграмм (пакеты `diagram`, `flowchart`, `draw`) или вставляйте PNG/SVG в `/doc/images/`

### 2. Практическая реализация

#### 2.1 Реализация сетевой архитектуры

**Что включить в инструкцию**:
- Объяснение того, как Docker создаёт виртуальные сети
- Именованные тома (named volumes) для управления данными
- Переопределение конфигурации через `docker-compose.bind.yml` для пользовательских путей
- Использование переменных окружения в `.env` файлах

**Примеры для включения**:
- Определение сети в `docker-compose.yml`
- Использование `env_file` для подключения переменных
- Примеры переопределения путей хранения

**DNS и маршрутизация доменов**:
- Собственный DNS-сервер на домашной инфраструктуре
  - Управление разрешением имён для внутренних сервисов
  - Настройка записей A для локальных доменов (например, `jellyfin.local`, `sonarr.local`)
  - Маршрутизация запросов к контейнерам через имена хостов
  
- Интеграция с Cloudflare для внешнего доступа
  - Использование купленного домена (например, `example.com`) и его привязка к Cloudflare
  - Динамическое обновление DNS записей при смене IP домашней сети (DDNS)
  - Настройка поддоменов для различных сервисов (например, `jellyfin.example.com`, `radarr.example.com`)
  - Использование Cloudflare Tunnel для безопасного туннелирования трафика без открытия портов на домашнем маршрутизаторе (альтернатива VPN)
  - SSL/TLS сертификаты через Cloudflare (Origin CA) или Let's Encrypt
  
- Архитектура разрешения имён:
  1. Локальный запрос → собственный DNS сервер → IP контейнера в Docker сети
  2. Удалённый запрос на `example.com` → Cloudflare DNS → домашняя сеть (DDNS или статический IP)
  3. Nginx Proxy Manager перенаправляет трафик к нужному контейнеру

**Примеры конфигурации**:
- Запись DNS для локального доступа (A запись на DNS сервере)
- Конфигурация DDNS клиента для обновления IP в Cloudflare
- Настройка Nginx Proxy Manager для работы с внешним доменом

#### 2.2 Организация контейнеров и их взаимодействие

**Что включить в инструкцию**:
- Цепочка взаимодействия для скачивания и управления медиа:
  0. Пользователь запрашивает контент через Jellyseerr
  1. Prowlarr выполняет поиск по индексерам
  2. Sonarr/Radarr/Lidarr инициируют загрузку через Prowlarr
  3. qBittorrent (через WireGuard) скачивает контент
  4. FileFlows обрабатывает и организует файлы
  5. Jellyfin сканирует и каталогизирует контент

- Конкретные примеры настройки:
  - Как подключить Sonarr к Prowlarr (URL, API-ключи)
  - Как настроить категории в qBittorrent и связать их с Sonarr/Radarr/Lidarr
  - Как интегрировать FileFlows для автоматической переккодировки видео

**Примеры кода**:
- Фрагменты конфига из `docker-compose.yml` для демонстрации переменных окружения
- Примеры настроечных файлов (может быть использован `config/` раздел)

### 3. Выбор оборудования

**Что включить в инструкцию**:
- Минимальные требования:
  - CPU: зависит от количества контейнеров (для базовой конфигурации — 4 ядра)
  - RAM: минимум 8 ГБ (рекомендуется 16+ ГБ)
  - Хранилище: SSD для системы (100+ ГБ), дополнительные диски для медиа

- Оптимальные конфигурации:
  - Для домашнего медиа-сервера
  - Для комбо медиа + мониторинга + развития

- **GPU и CUDA**:
  - Когда нужна видеокарта (кодирование видео в Jellyfin, FileFlows)
  - Настройка docker-compose для доступа к GPU
  - Альтернативы для процессоров без CUDA

- Примеры реальных конфигураций:
  - Старые ноутбуки / мини-ПК (Intel NUC, Raspberry Pi)
  - Выделенные серверы
  - NAS-системы с Docker поддержкой

### 4. Безопасность

**Что включить в инструкцию**:
- Модель безопасности self-hosted решений:
  - Пользователь несёт ответственность за все аспекты безопасности
  - Отсутствие центрального управления безопасностью (как в облачных сервисах)

- Практические меры:
  - Использование сильных паролей и переменных окружения
  - VPN как основной способ защиты трафика
  - Сегментация сетей Docker для изоляции компонентов
  - Регулярное обновление образов контейнеров (через auto-update сервис)
- SSL/TLS сертификаты через Let's Encrypt в Nginx Proxy Manager
- Zero-trust модель безопасности при использовании VPN

- Конфигурация сетей:
  - Разделение сервисов по сетям (публичные сервисы vs. приватные)
  - Использование `external: true` для управляемых сетей
  - Firewall и правила доступа на уровне хоста

- Мониторинг и логирование:
  - Настройка логирования контейнеров
  - Использование Prometheus/Grafana для мониторинга аномалий
  - Раннее обнаружение проблем

### 5. Публикация инфраструктуры и удалённый доступ

**Что включить в инструкцию**:
- **Проблема**: Как безопасно получить доступ к домашней лаборатории извне сети?

- **Решение через VPN**:
  - WireGuard как VPN-сервер (контейнер или хост)
  - Генерация конфигов для клиентов
  - Подключение удалённых устройств к домашней сети

- **Многоуровневая архитектура доступа**:
  - Уровень 1: Удалённое устройство подключается к VPN
  - Уровень 2: Через VPN попадает в домашнюю сеть Docker
  - Уровень 3: Nginx Proxy Manager маршрутизирует запросы к сервисам

- **Примеры конфигурации**:
  - Файл конфигурации WireGuard (`config/wireguard/wg0.conf.example`)
  - Настройка правил маршрутизации
  - Использование доменов и DNS для удобства доступа

- **Альтернативные подходы**:
  - Tailscale как более простая альтернатива WireGuard
  - Port Forwarding с дополнительными мерами безопасности (не рекомендуется)
  - Если нет статического внешнего IP адреса и интернет провайдер блокирует входящие подключения, используем схему Peer 1 to Public server to Peer 2 через внешнюю VPS.

---

## Технические требования к документации

### Структурирование Typst документа

```typst
= Введение
// Содержание раздела

= Архитектура
// Общее описание архитектуры

== Сетевая архитектура
// Подробное описание, диаграммы

== Взаимодействие сервисов
// Цепочки взаимодействия, диаграммы

= Реализация
// Практические примеры

// ... и т.д.
```

### Встраивание кода

**Вставка кода с фигурой и подписью**:

```typst
#figure(
  ```yaml
  # Пример docker-compose.yml:
  services:
    jellyfin:
      image: nyanmisaka/jellyfin:latest
      container_name: jellyfin
      restart: unless-stopped
      volumes:
        - jellyfin-cache:/cache
        - /path/to/media:/media
  ```,
  caption: [Конфигурация сервиса Jellyfin],
) <jellyfin-config>
```

**Особенности синтаксиса**:
- Язык кода указывается после первых трёх обратных кавычек (yaml, bash, python, docker-compose и т.д.)
- Подпись (caption) описывает содержимое кода
- Тег в формате `<tag-name>` позволяет ссылаться на этот элемент (например, `@jellyfin-config`)

**Для ссылок на исходный код без полного встраивания**:
```typst
Конфигурация находится в файле #link("../src/media/docker-compose.yml")[docker-compose.yml].
```

### Встраивание изображений

**Вставка изображения с фигурой и подписью**:

```typst
#figure(
  image("images/network-architecture.png", width: 80%),
  caption: [Архитектура сетевой инфраструктуры],
) <network-arch-diagram>
```

**Параметры**:
- `width: 80%` — ширина изображения относительно текста (используйте 40-100% в зависимости от размера)
- `caption: [...]` — подпись к изображению (кроссреференция автоматически добавит номер)
- `<tag-name>` — уникальный тег для ссылки

Сохраняйте изображения в `/doc/images/` с понятными названиями:
- `network-architecture.png`
- `container-interaction.png`
- `deployment-diagram.png`
- `equipment-setup.png`

### Встраивание таблиц

**Вставка таблицы с фигурой и подписью**:

```typst
#figure(
  table(
    columns: 4,
    table.header([Компонент], [Назначение], [Порт], [Статус]),
    [Jellyfin], [Потоковая передача], [8096], [Критический],
    [Sonarr], [Управление сериалами], [8989], [Важный],
    [qBittorrent], [Торрент-клиент], [8080], [Важный],
    [Nginx Proxy Manager], [Обратный прокси], [80/443], [Критический],
  ),
  caption: [Основные сервисы инфраструктуры],
) <services-table>
```

**Параметры**:
- `columns: N` — количество столбцов в таблице
- `table.header(...)` — заголовок таблицы (первая строка выделяется автоматически)
- `caption: [...]` — подпись к таблице
- `<tag-name>` — уникальный тег для кросс-ссылки

### Кросс-ссылки на элементы (таблицы, рисунки, код)

**Синтаксис ссылки**:
```typst
На @network-arch-diagram показана архитектура сети.

Как видно из @services-table, критические сервисы требуют особого внимания.

В @jellyfin-config приведён пример конфигурации Jellyfin.
```

**Результат**: Typst автоматически подставит номер элемента, например "На рисунке 1.2 показана архитектура сети".

**Правила для тегов**:
- Используйте понятные, описательные названия (например, `<network-arch-diagram>`, а не `<fig1>`)
- Тег должен быть уникальным в документе
- Предпочтительно использовать латинские буквы и дефисы

---

## Когда обращаться к исходному коду

Обращайтесь к файлам в `/src/` когда нужно:

1. **Демонстрировать реальную конфигурацию**
   - Примеры docker-compose.yml
   - Файлы .env.example
   - Конфигурационные файлы из config/

2. **Показывать взаимодействие сервисов**
   - Том, как сервисы подключены друг к другу
   - Переменные окружения для коммуникации

3. **Объяснять архитектуру**
   - Структура директорий и организация
   - Использование именованных объёмов и bind-mount

**Не обращайтесь** только для того, чтобы наполнить текст кодом без смысла. Если один сервис похож по конфигурации на другой, достаточно показать один пример и описать отличия текстом. Например, не стоит описывать весь *-arr стек, достаточно показать Sonarr и упомянуть, что Radarr и Lidarr аналогичны.

---

## Порядок работы при написании документации

1. **Планирование**: Определите основные разделы и подтемы на основе пяти главных областей (см. выше)

2. **Сбор контекста**: 
   - Прочитайте все README.md в `/src/`
   - Изучите docker-compose.yml и docker-compose.bind.yml для каждого сервиса
   - Посмотрите на конфигурационные примеры в `/src/*/config/`

3. **Написание раздела**:
   - Начните с концепции и объяснения
   - Затем приведите примеры из кода (как ссылки или малые фрагменты)
   - Завершите с выводами

4. **Визуализация**:
   - Создавайте диаграммы для сложных понятий (архитектура, потоки данных)
   - Используйте встроенные возможности Typst или внешние инструменты (draw.io, graphviz)

5. **Проверка**:
   - Убедитесь, что все ссылки ведут к правильным файлам
   - Проверьте, что код корректно отображается
   - Убедитесь, что язык — русский, стиль — научный

---

## Интеграция с ГОСТом

Документация должна соответствовать требованиям ГОСТ для курсовых работ:

- Оформление по ГОСТ 7.32-2001 (отчёты о научно-исследовательской работе)
- Использование пакета `typst-gost.ru` для автоматического форматирования
- Нумерованные заголовки, сквозная нумерация формул и рисунков
- Заключение с выводами

Документация автоматически формируется на основе готового шаблона ГОСТа, поэтому сосредоточьтесь на содержании и структуре, а не на деталях форматирования.

---

## Дополнительные рекомендации

### Стиль написания

- Научный, объективный, официальный тон
- Активный залог там, где возможно
- Избегайте разговорной речи и сленга

### Структурирование информации

- Используйте маркированные списки для перечисления
- Используйте нумерованные списки для последовательности
- Таблицы для сравнения характеристик (требования к ПО, конфигурации, и т.д.)

### Примеры и иллюстрации

- Каждый раздел должен содержать хотя бы одну иллюстрацию или таблицу
- Примеры должны быть реальными (из проекта)
- Диаграммы должны быть понятны людям, незнакомым с Docker

---

## 6. Развёртывание и запуск

### 6.1 Предварительная подготовка

- **Системные требования**:
  - Установленные Docker и Docker Compose
  - Доступ к файловой системе для создания директорий хранилища
  - Открытые сетевые порты (если используется port forwarding вместо VPN)
  - Администраторский доступ для настройки DNS и firewall

- **Подготовка окружения**:
  - Клонирование репозитория
  - Создание структуры директорий для данных (если используется bind-mount)
  - Настройка переменных окружения в `.env` файлах
  - Генерация безопасных паролей и ключей шифрования

### 6.2 Инициализация инфраструктуры

- **Порядок запуска сервисов** (рекомендуемая последовательность):
  1. Создание необходимых Docker сетей (`proxiable` и других)
  2. Запуск Nginx Proxy Manager (требуется для остальных сервисов)
  3. Запуск DNS сервера (если используется собственный DNS)
  4. Запуск VPN сервера (WireGuard) для удалённого доступа
  5. Запуск остальных сервисов в зависимости от их зависимостей

- **Примеры команд**:
  ```bash
  # Создание сети
  docker network create proxiable
  
  # Запуск сервиса с именованными томами
  docker compose -f src/proxy/docker-compose.yml up -d
  
  # Запуск с переопределением путей хранения
  HOST_APPDATA=/mnt/nas/data docker compose -f src/dashboard/docker-compose.yml -f docker-compose.bind.yml up -d
  ```

### 6.3 Первичная конфигурация

- **Nginx Proxy Manager**:
  - Доступ к админ-панели (http://localhost:81)
  - Смена пароля по умолчанию
  - Добавление хостов для локальных сервисов
  - Настройка SSL сертификатов

- **DNS сервер** (если используется):
  - Настройка зон и записей A для локальных доменов
  - Убедитесь, что домашние устройства используют этот DNS (настройка в router или DHCP)
  - Проверка разрешения имён: `nslookup jellyfin.local` (должен вернуть IP контейнера)

- **Cloudflare и внешний домен**:
  - Добавление A записи в Cloudflare для основного домена или использование DDNS клиента
  - Настройка поддоменов для каждого сервиса
  - Конфигурация Nginx Proxy Manager для внешних доменов
  - (Опционально) Настройка Cloudflare Tunnel для безопасного туннелирования без открытия портов

- **VPN (WireGuard)**:
  - Генерация конфигов для клиентов
  - Экспорт конфигов QR-кодов для мобильных устройств
  - Тестирование подключения с удалённого устройства

### 6.4 Настройка взаимодействия сервисов

- **Связь между контейнерами**:
  - Использование имён контейнеров как DNS имён в Docker сети
  - Примеры API URL для связи сервисов (например, Sonarr → Prowlarr)
  - Генерация и обмен API ключами

- **Путём хранения данных**:
  - Убедитесь, что все сервисы имеют доступ к нужным путям
  - Проверьте права доступа на файловой системе (permissions)
  - Создайте необходимые подиректории для разных типов контента

### 6.5 Проверка и тестирование

- **Локальный доступ**:
  - Проверка доступа к сервисам через локальные IP адреса
  - Проверка доступа через локальные доменные имена (через собственный DNS)
  - Проверка связи между контейнерами (логи, тесты API)

- **Внешний доступ**:
  - Проверка доступа через VPN
  - Проверка доступа через Cloudflare домен (если настроен)
  - Проверка SSL/TLS сертификатов (HTTPS)

- **Мониторинг и логи**:
  - Просмотр логов контейнеров для выявления ошибок
  - Проверка метрик в Grafana (если включён мониторинг)
  - Подтверждение, что все сервисы работают и взаимодействуют корректно